<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-money-bill-wave text-success me-2"></i>Cash Management</h1>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                <i class="fas fa-plus me-2"></i>Add Transaction
            </button>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-2">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-arrow-down me-2"></i>Total Income</h6>
                <h2 class="mb-0">$<%= totalIncome.toFixed(2) %></h2>
            </div>
        </div>
    </div>
    <div class="col-md-4  mb-2">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-arrow-up me-2"></i>Total Expenses</h6>
                <h2 class="mb-0">$<%= totalExpense.toFixed(2) %></h2>
            </div>
        </div>
    </div>
    <div class="col-md-4  mb-2">
        <div class="card <%= balance >= 0 ? 'bg-primary' : 'bg-warning' %> text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-wallet me-2"></i>Balance</h6>
                <h2 class="mb-0">$<%= balance.toFixed(2) %></h2>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-md-3  mb-2">
        <select id="typeFilter" class="form-select">
            <option value="">All Types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
        </select>
    </div>
    <div class="col-md-3  mb-2">
        <select id="categoryFilter" class="form-select">
            <option value="">All Categories</option>
            <% categories.forEach(cat => { %>
                <option value="<%= cat.code %>"><%= cat.name %> (<%= cat.type %>)</option>
            <% }); %>
        </select>
    </div>
    <div class="col-md-3  mb-2">
        <input type="date" id="dateFilter" class="form-control" placeholder="Filter by date">
    </div>
    <div class="col-md-3  mb-2">
        <button id="clearFilters" class="btn btn-outline-secondary w-100">
            <i class="fas fa-times me-1"></i>Clear Filters
        </button>
    </div>
</div>

<!-- Transactions Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>All Transactions (<span id="transactionCount"><%= transactions.length %></span>)</h5>
            </div>
            <div class="card-body">
                <% if (transactions.length === 0) { %>
                <div class="text-center py-5">
                    <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Transactions Found</h4>
                    <p class="text-muted">Start by adding your first transaction.</p>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                        <i class="fas fa-plus me-2"></i>Add First Transaction
                    </button>
                </div>
                <% } else { %>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Reference</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <% transactions.forEach(transaction => { %>
                            <tr class="transaction-row"
                                data-type="<%= transaction.type %>"
                                data-category="<%= transaction.category_code %>"
                                data-date="<%= transaction.transaction_date %>"
                                data-transaction-id="<%= transaction.id %>"
                                data-transaction-date="<%= transaction.transaction_date %>"
                                data-transaction-type="<%= transaction.type %>"
                                data-transaction-amount="<%= transaction.amount %>"
                                data-transaction-category="<%= transaction.category_code %>"
                                data-transaction-description="<%= transaction.description || '' %>"
                                data-transaction-payment="<%= transaction.payment_method || '' %>"
                                data-transaction-reference="<%= transaction.reference_number || '' %>">
                                <td><%= new Date(transaction.transaction_date).toLocaleDateString() %></td>
                                <td>
                                    <% if (transaction.type === 'income') { %>
                                        <span class="badge bg-success"><i class="fas fa-arrow-down me-1"></i>Income</span>
                                    <% } else { %>
                                        <span class="badge bg-danger"><i class="fas fa-arrow-up me-1"></i>Expense</span>
                                    <% } %>
                                </td>
                                <td><span class="badge bg-info"><%= transaction.category_name %></span></td>
                                <td><%= transaction.description || 'N/A' %></td>
                                <td class="fw-bold <%= transaction.type === 'income' ? 'text-success' : 'text-danger' %>">
                                    <%= transaction.type === 'income' ? '+' : '-' %>$<%= parseFloat(transaction.amount).toFixed(2) %>
                                </td>
                                <td><%= transaction.payment_method || 'N/A' %></td>
                                <td><%= transaction.reference_number || 'N/A' %></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1 edit-transaction-btn" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-transaction-btn" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add New Transaction
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/cash" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="transaction_date" class="form-label">Date *</label>
                        <input type="date" class="form-control" id="transaction_date" name="transaction_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="type" class="form-label">Type *</label>
                        <select class="form-control" id="type" name="type" required>
                            <option value="">Select Type</option>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="category_code" class="form-label">Category *</label>
                        <select class="form-control" id="category_code" name="category_code" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount *</label>
                        <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <input type="text" class="form-control" id="payment_method" name="payment_method" placeholder="e.g., Cash, InstaPay, Bank Transfer">
                    </div>
                    
                    <div class="mb-3">
                        <label for="reference_number" class="form-label">Reference Number</label>
                        <input type="text" class="form-control" id="reference_number" name="reference_number">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Add Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Transaction
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTransactionForm" method="POST">
                <input type="hidden" id="edit_transaction_id" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_transaction_date" class="form-label">Date *</label>
                        <input type="date" class="form-control" id="edit_transaction_date" name="transaction_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_type" class="form-label">Type *</label>
                        <select class="form-control" id="edit_type" name="type" required>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_category_code" class="form-label">Category *</label>
                        <select class="form-control" id="edit_category_code" name="category_code" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_amount" class="form-label">Amount *</label>
                        <input type="number" step="0.01" class="form-control" id="edit_amount" name="amount" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_payment_method" class="form-label">Payment Method</label>
                        <input type="text" class="form-control" id="edit_payment_method" name="payment_method">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_reference_number" class="form-label">Reference Number</label>
                        <input type="text" class="form-control" id="edit_reference_number" name="reference_number">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Categories data
const categories = <%- JSON.stringify(categories) %>;

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('transaction_date').value = today;
    
    // Handle type change to filter categories
    document.getElementById('type').addEventListener('change', function() {
        updateCategoryOptions('category_code', this.value);
    });
    
    document.getElementById('edit_type').addEventListener('change', function() {
        updateCategoryOptions('edit_category_code', this.value);
    });
    
    // Edit button handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-transaction-btn')) {
            const row = e.target.closest('.transaction-row');
            const id = row.getAttribute('data-transaction-id');
            const date = row.getAttribute('data-transaction-date');
            const type = row.getAttribute('data-transaction-type');
            const amount = row.getAttribute('data-transaction-amount');
            const category = row.getAttribute('data-transaction-category');
            const description = row.getAttribute('data-transaction-description');
            const payment = row.getAttribute('data-transaction-payment');
            const reference = row.getAttribute('data-transaction-reference');
            
            document.getElementById('edit_transaction_id').value = id;
            document.getElementById('edit_transaction_date').value = date;
            document.getElementById('edit_type').value = type;
            document.getElementById('edit_amount').value = amount;
            document.getElementById('edit_description').value = description;
            document.getElementById('edit_payment_method').value = payment;
            document.getElementById('edit_reference_number').value = reference;
            
            updateCategoryOptions('edit_category_code', type);
            document.getElementById('edit_category_code').value = category;
            
            document.getElementById('editTransactionForm').action = '/cash/' + id + '/edit';
            
            const modal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
            modal.show();
        }
        
        // Delete button handler
        if (e.target.closest('.delete-transaction-btn')) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                const row = e.target.closest('.transaction-row');
                const id = row.getAttribute('data-transaction-id');
                
                fetch('/cash/' + id + '/delete', {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Error deleting transaction');
                    }
                });
            }
        }
    });
    
    // Filter functionality
    const typeFilter = document.getElementById('typeFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    const dateFilter = document.getElementById('dateFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    
    function filterTransactions() {
        const typeValue = typeFilter.value;
        const categoryValue = categoryFilter.value;
        const dateValue = dateFilter.value;
        
        const rows = document.querySelectorAll('.transaction-row');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const type = row.getAttribute('data-type');
            const category = row.getAttribute('data-category');
            const date = row.getAttribute('data-date');
            
            const typeMatch = !typeValue || type === typeValue;
            const categoryMatch = !categoryValue || category === categoryValue;
            const dateMatch = !dateValue || date === dateValue;
            
            if (typeMatch && categoryMatch && dateMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        document.getElementById('transactionCount').textContent = visibleCount;
    }
    
    typeFilter.addEventListener('change', filterTransactions);
    categoryFilter.addEventListener('change', filterTransactions);
    dateFilter.addEventListener('change', filterTransactions);
    
    clearFiltersBtn.addEventListener('click', function() {
        typeFilter.value = '';
        categoryFilter.value = '';
        dateFilter.value = '';
        filterTransactions();
    });
});

function updateCategoryOptions(selectId, type) {
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">Select Category</option>';
    
    const filteredCategories = type ? categories.filter(c => c.type === type) : categories;
    
    filteredCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.code;
        option.textContent = cat.name;
        select.appendChild(option);
    });
}
</script>
